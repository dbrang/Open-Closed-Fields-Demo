<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Open vs Closed Field EEG – Final Model</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
body{margin:0;background:#020617;color:#e5e7eb;font-family:system-ui,Segoe UI,Roboto}
.wrap{max-width:1200px;margin:0 auto;padding:16px}
h1{font-size:18px;margin:0 0 6px}
.panel{background:#0b1220;border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:12px}
.grid{display:grid;grid-template-columns:2fr 1fr;gap:12px}
.controls label{display:flex;justify-content:space-between;font-size:12px;margin:10px 0 4px}
.controls input[type=range]{width:100%}
.controls input[type=checkbox]{margin-right:6px}
canvas{background:#020617;border:1px solid rgba(255,255,255,.12);border-radius:12px}
.small{font-size:12px;color:rgba(229,231,235,.6)}
.row{display:flex;align-items:center;gap:8px;font-size:13px}
</style>
</head>
<body>
<div class="wrap">
<h1>EEG Open vs Closed Field – Geometric Model</h1>
<div class="grid">
<div class="panel">
<canvas id="cortex" width="720" height="420"></canvas>
<div class="small">Pyramidal neurons rotate around their soma. L6 neurons span multiple layers. Stellate cells (L4) remain locally symmetric.</div>
</div>

<div class="panel controls">
<label>Alignment <span id="alignVal">100%</span></label>
<input id="align" type="range" min="0" max="1" step="0.01" value="1" oninput="document.getElementById('alignVal').innerText = Math.round(this.value*100)+'%'">

<label>Frequency <span id="freqVal">1 Hz</span></label>
<input id="freq" type="range" min="0.2" max="10" step="0.1" value="1" oninput="document.getElementById('freqVal').innerText = this.value+' Hz'">

<hr style="border:none;border-top:1px solid rgba(255,255,255,.12);margin:12px 0">

<div class="row">
<input type="checkbox" id="showL23" checked> L2/3 pyramidal
</div>
<div class="row">
<input type="checkbox" id="showL6" checked> L6 pyramidal
</div>
<div class="row">
<input type="checkbox" id="showStellate" checked> Stellate (L4)
</div>

<hr style="border:none;border-top:1px solid rgba(255,255,255,.12);margin:12px 0">

<div class="row">
<input type="checkbox" id="visualizeFiring" checked> <strong>Visualize Firing</strong>
</div>

<canvas id="eeg" width="360" height="160" style="margin-top:12px"></canvas>
<div class="small">EEG trace represents the summed vertical potential of all active neurons.</div>
</div>
</div>
</div>

<script>
const cortex=document.getElementById("cortex");
const ctx=cortex.getContext("2d");
const eeg=document.getElementById("eeg");
const ectx=eeg.getContext("2d");

// Layers definitions
const layers=[
{name:"I",y:60},{name:"II/III",y:140},{name:"IV",y:220},{name:"V/VI",y:330}
];

// Pre-calculate random seeds for every possible neuron so they rotate stably
const neuronMap = [];
for(let c=0; c<10; c++){
    neuronMap[c] = [];
    for(let l=0; l<5; l++){
        neuronMap[c][l] = {
            angleOffset: (Math.random() - 0.5) * 2 * Math.PI, 
            phaseOffset: Math.random() * 2 * Math.PI 
        };
    }
}

let t=0,last=performance.now();

// Helper to get color with alpha based on activity
function getDynamicColor(baseColorHex, activity, isFiringEnabled) {
    if(!isFiringEnabled) return baseColorHex;
    // Activity is sin wave -1 to 1. Map to opacity 0.3 to 1.0
    const intensity = 0.4 + 0.6 * ((activity + 1) / 2);
    
    // Convert hex to rgb
    const r = parseInt(baseColorHex.slice(1,3), 16);
    const g = parseInt(baseColorHex.slice(3,5), 16);
    const b = parseInt(baseColorHex.slice(5,7), 16);
    
    return `rgba(${r},${g},${b},${intensity})`;
}

function drawPyramidal(x, ySoma, length, angle, color) {
    ctx.save();
    ctx.translate(x, ySoma);
    ctx.rotate(angle); 

    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.fillStyle = color;

    // Soma
    ctx.beginPath();
    ctx.arc(0, 0, 6, 0, Math.PI * 2);
    ctx.fill();

    // Apical Dendrite
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.lineTo(0, -length);
    ctx.stroke();

    // Apical tuft
    ctx.beginPath();
    ctx.moveTo(0, -length);
    ctx.lineTo(-8, -length - 10);
    ctx.moveTo(0, -length);
    ctx.lineTo(8, -length - 10);
    ctx.stroke();

    // Basal dendrites
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.lineTo(-6, 10);
    ctx.moveTo(0,0);
    ctx.lineTo(6, 10);
    ctx.stroke();

    ctx.restore();
}

function drawStellateNeuron(x, y, color) {
    ctx.fillStyle = color;
    ctx.strokeStyle = color;
    ctx.lineWidth = 1.5;

    ctx.beginPath();
    ctx.arc(x, y, 5, 0, Math.PI*2);
    ctx.fill();

    const processes = 6;
    for(let i=0; i<processes; i++) {
        const angle = (i / processes) * Math.PI * 2;
        const len = 12;
        const ex = x + Math.cos(angle) * len;
        const ey = y + Math.sin(angle) * len;
        const cx = x + Math.cos(angle + 0.5) * (len/2);
        const cy = y + Math.sin(angle + 0.5) * (len/2);

        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.quadraticCurveTo(cx, cy, ex, ey);
        ctx.stroke();
    }
}

function draw(){
    ctx.clearRect(0,0,cortex.width,cortex.height);

    // -- Background Layers --
    ctx.font="12px system-ui";
    layers.forEach(L=>{
        ctx.fillStyle="rgba(255,255,255,.04)";
        ctx.fillRect(0,L.y-30,cortex.width,60);
        ctx.fillStyle="rgba(255,255,255,.4)";
        ctx.fillText("Layer "+L.name,8,L.y-18);
    });

    // -- Skull/Scalp --
    ctx.fillStyle="rgba(200,200,255,.08)";
    ctx.fillRect(0,0,cortex.width,20); 
    ctx.fillStyle="rgba(200,200,200,.12)";
    ctx.fillRect(0,20,cortex.width,20); 
    ctx.fillStyle="rgba(255,200,200,.12)";
    ctx.fillRect(0,40,cortex.width,20); 

    // -- Wide Electrode --
    ctx.fillStyle="rgba(255,255,255,0.9)";
    ctx.beginPath();
    // Ellipse center x, y, radiusX, radiusY, rotation, start, end
    ctx.ellipse(cortex.width/2, 20, cortex.width*0.4, 14, 0, 0, Math.PI*2);
    ctx.fill();
    
    // Electrode Label
    ctx.fillStyle = "#020617";
    ctx.font = "bold 12px system-ui";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("Scalp EEG Electrode", cortex.width/2, 20);
    ctx.textAlign = "left"; // reset

    const cols=8, lanes=4;
    const dx=cortex.width/(cols+1);
    
    // Inputs
    const alignVal = Number(document.getElementById("align").value);
    const freqVal = Number(document.getElementById("freq").value);
    const showFiring = document.getElementById("visualizeFiring").checked;
    
    // Fixed / Hidden parameters
    const syncVal = 0.5; 
    const fieldType = "open";

    let netInstantaneous = 0; 

    for(let c=0; c<cols; c++){
        for(let l=0; l<lanes; l++){
            const x = dx*(c+1) + (l-1.5)*12;
            const seed = neuronMap[c][l]; 

            let deviation = seed.angleOffset * (1 - alignVal);
            const verticalContribution = Math.cos(deviation);

            // Phase calculation
            const phase = (t * freqVal * Math.PI * 2) + (seed.phaseOffset * (1 - syncVal));
            const activity = Math.sin(phase);

            // 1. Layer 2/3 Pyramidal
            if(l===0 && showL23.checked){
                const col = getDynamicColor("#ff7849", activity, showFiring);
                drawPyramidal(x, layers[1].y+20, 50, deviation, col);
                netInstantaneous += activity * verticalContribution * 1.0; 
            }

            // 2. Stellate (Layer 4)
            if(l===1 && showStellate.checked){
                const col = getDynamicColor("#9aa5ff", activity, showFiring);
                drawStellateNeuron(x, layers[2].y, col);
                netInstantaneous += activity * 0.05; 
            }

            // 3. Layer 6 Pyramidal (Longer, crossing layers)
            if(l>=2 && showL6.checked){
                const col = getDynamicColor("#ffd1a8", activity, showFiring);
                // Length increased to 200 to reach near top layers
                drawPyramidal(x, layers[3].y+20, 200, deviation, col);
                netInstantaneous += activity * verticalContribution * 1.2;
            }
        }
    }

    // -- Draw EEG Trace --
    ectx.clearRect(0,0,eeg.width,eeg.height);
    ectx.strokeStyle="#38bdf8";
    ectx.lineWidth=2;
    ectx.beginPath();

    // Envelope calculation
    let systemGain = 0;
    for(let c=0; c<cols; c++){
        for(let l=0; l<lanes; l++){
            const seed = neuronMap[c][l];
            const deviation = seed.angleOffset * (1 - alignVal);
            const vert = Math.cos(deviation);

            if(l===0 && showL23.checked) systemGain += vert * 1.0;
            if(l===1 && showStellate.checked) systemGain += 0.05; 
            if(l>=2 && showL6.checked) systemGain += vert * 1.2;
        }
    }

    const syncDamping = 0.1 + (0.9 * syncVal); 
    const finalAmp = systemGain * syncDamping;

    for(let i=0; i<eeg.width; i++){
        const tt = t - (eeg.width - i)*0.01; 
        const wave = Math.sin(2 * Math.PI * freqVal * tt);
        const y = eeg.height/2 - (finalAmp * wave * 2.5); 
        if(i===0) ectx.moveTo(i,y); else ectx.lineTo(i,y);
    }
    ectx.stroke();
}

function loop(now){
    const dt=(now-last)/1000;
    last=now;
    t+=dt;
    draw();
    requestAnimationFrame(loop);
}

const showL23=document.getElementById("showL23");
const showL6=document.getElementById("showL6");
const showStellate=document.getElementById("showStellate");

loop(performance.now());
</script>
</body>
</html>